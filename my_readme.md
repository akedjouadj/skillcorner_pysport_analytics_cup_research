# The Off-Ball Rating: A Comprehensive Framework for Evaluating Player Movement Without Possession

A complete analytical framework designed to evaluate off-ball player movement in football, developed for the SkillCorner x PySport Analytics Cup.

## üìã Overview

The **Off-Ball Rating (OBR)** is an innovative metric designed to quantify player contribution during the approximately **97% of match time spent without the ball**. The framework combines two complementary components:

- **OCR (Option Creation Rating)**: evaluates offensive off-ball movement and passing option creation  
- **SCR (Space Control Rating)**: evaluates defensive positioning, spatial control, and pass lane disruption  

Together, these components provide a structured and interpretable representation of off-ball impact.

## üèóÔ∏è System Architecture

off-ball-rating/
‚îÇ
‚îú‚îÄ‚îÄ config.py # Global configuration and constants
‚îú‚îÄ‚îÄ utils.py # Geometric utilities, offside detection, and helper functions
‚îú‚îÄ‚îÄ data_loader.py # Data loading and preprocessing pipeline
‚îú‚îÄ‚îÄ xt_grid.py # Expected Threat (xT) spatial grid
‚îú‚îÄ‚îÄ offense_rating.py # Offensive rating computation (OCR)
‚îú‚îÄ‚îÄ defense_rating.py # Defensive rating computation (SCR)
‚îî‚îÄ‚îÄ analyze_offbr_outputs.py # Analysis utilities for OffBR outputs

## üìä Required Data Format

### Tracking Data (CSV)

The framework relies on SkillCorner tracking data loaded via **kloppy**, together with official match metadata provided by SkillCorner in the file `{match_id}_match.json`.

Tracking data is loaded directly from SkillCorner‚Äôs public GitHub repositories using `kloppy`, while match metadata files must be downloaded manually and stored in the following directory structure:

data/
‚îî‚îÄ‚îÄ match_{match_id}/
‚îî‚îÄ‚îÄ match.json

The raw tracking data is processed into a unified pandas DataFrame with the following required columns:

- `frame_id`: unique frame identifier  
- `time_stamp`: timestamp in seconds  
- `period`: match period (1 or 2)  
- `ball_x`, `ball_y`: ball position  
- `team_id`: team identifier  
- `player_id`: player identifier  
- `x`, `y`: player position  
- `possession_team_id`: team currently in possession  
- `is_ball_carrier`: boolean indicating ball possession (computed if not provided)  

All spatial coordinates are translated so that the origin `(0, 0)` corresponds to the lower-left corner of the pitch.

The `{match_id}_match.json` file is also used to store computed outputs generated by the framework.

## üöÄ Installation

The framework relies exclusively on standard Python scientific libraries.

```bash
pip install -r requirements.txt
```

## Usage

Please refer to the notebook submission.ipynb, which demonstrates the complete pipeline from data loading to metric computation and analysis.

## Methodology

### 1. Option Creation Rating (OCR)

**Concept**: OCR measures how off-ball movements create valuable passing options for the ball carrier.

**Definition**:
```
- POV = ‚àö( P(reception) √ó xT(receiver_position) )
- OCR = average POV over rolling 2-second windows
```

**Reception Probability Modeling**:
- Distance factor: exponential decay with pass distance
- Defender obstruction: angle-based interference and proximity to the passing lane
- Offside detection: offside positions automatically receive a value of zero

### 2. Space Control Rating (SCR)

**Concept**: SCR measures defensive space control and the ability to disrupt potential passes.

**Components**:
- Zone coverage: proportion of high-xT danger zones covered by the defender
- Pass line blocking: proportion of potential passing lanes that the defender can effectively block

**Definition**:
```
SCR = (Zone Coverage + Pass Line Blocking) / 2
```

SCR values are averaged over rolling 1-second windows across the match.

### 3. Final Off-Ball Rating
```
OBR = (OCR, SCR)
```

The Off-Ball Rating is intentionally kept as a two-dimensional metric to preserve interpretability and enable richer player profiling.

## ‚öôÔ∏è Configuration

All key parameters can be adjusted in config.py, including OCR computation frequency (default: 2 seconds), SCR computation frequency (default: 1 second), Distance thresholds and spatial parameters.

## üìà Outputs

For each match, outputs are stored in: `outputs/data/match_{match_id}/`.

Within `submission.ipynb`, a consolidated pandas DataFrame is generated containing average offensive and defensive metrics per player, alongside a .pickle file storing full temporal sequences.

- Output DataFrame Columns
`player_id`: unique player identifier
`player_name`: player name
`position`: player position (SkillCorner notation)
`position_group`: positional group (SkillCorner notation)
`team_id`: team identifier
`team_name`: team name
`match_outcome`: W / D / L
`avg_option_creation_rating`: average OCR
`playing_time`: minutes played
`avg_zone_coverage`: average zone coverage ratio
`avg_pass_line_blocking`: average pass line blocking ratio
`avg_space_control_rating`: average SCR

- Pickle Dictionary Structure
```json
{
    "player_id": {
        "seq_option_creation_rating": "...OCR time series (2s resolution)...",
        "seq_zone_coverage": "...zone coverage time series...",
        "seq_pass_line_blocking": "...pass line blocking time series...",
        "seq_space_control_rating": "...SCR time series..."
    },
    "..."
}
```

### 1. Output Analysis

Two types of analysis are presented in `submission.ipynb`, including positional profiling and temporal evolution of off-ball metrics.

### 2. Visualization

The OffenseRating and DefenseRating classes (in `offense_rating.py` and `defense_rating.py`) include visualization utilities for interpretability and debugging.

1. Visualize passing reception probabilities for all potential receivers in a given frame.

- Args:
    - receivers (List[Tuple[float, float]]): List of (x, y) positions for all potential receivers on the team in possession.
    - passer (Tuple[float, float]): (x, y) position of the ball carrier.
    - defenders (List[Tuple[float, float]]): List of (x, y) positions for all opposing defenders.

2. Visualize Passing Option Value (POV) for all potential receivers in a single frame.

- Args:
    - home_team_id (int): Identifier of the team in possession.
    - away_team_id (int): Identifier of the defending team.
    - frame (pandas.DataFrame): Tracking data for a single frame containing player positions and metadata (e.g., x, y, team_id, player_id, is_ball_carrier).
    - pov_dict (Dict[str, float]): Dictionary mapping each attacking player_id to its Passing Option Value for the given frame.

3. Visualize danger zones and defensive coverage for a single tracking frame.

- Args:
    - frame_data (pandas.DataFrame): Tracking data for a single frame containing player positions and metadata, including `x`, `y`, `team_id`, `player_id`, `is_ball_carrier` and `possession_team_id`.

4. Visualize pass line blocking by defenders for a single tracking frame.

- Args:
    - frame_data (pandas.DataFrame): Tracking data for a single frame containing player positions and metadata, including `x`, `y`, `team_id`, `player_id`, `is_ball_carrier`, and `possession_team_id`.

## ‚ö†Ô∏è Limitations
- Ball speed and player velocity are not currently integrated when assessing blockable pass lines
- Static xT grid (no dynamic context adaptation)
- Fixed temporal aggregation windows (2s for OCR, 1s for SCR)
- No learning-based calibration of parameters

## ü§ù Contribution

This framework is designed to be extensible. Possible contributions include:

- Improving the reception probability model
- Refining the xT grid using empirical data
- Adding new off-ball components (e.g., pressing intensity, marking quality)